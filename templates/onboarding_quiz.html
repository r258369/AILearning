{% extends 'base.html' %}
{% load static %}

{% block title %}Onboarding Quiz{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    :root {
        --light-gray: #f3f4f6;
        --primary-blue: #007CFF;
        --dark-text: #1f2937;
        --border-color: #d1d5db;
        --input-background: #ffffff;
        --text-color: #111827;
        --primary-blue-rgb: 0, 124, 255;
    }

    .quiz-container {
        max-width: 700px;
        margin: 50px auto;
        padding: 30px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark-text);
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1em;
        color: var(--text-color);
        background-color: var(--input-background);
    }

    .form-group ul.errorlist {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: 5px;
        list-style-type: none;
        padding-left: 0;
    }

    .btn {
        padding: 10px 20px;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
    }

    /* Enhanced Loader Wrapper */
    #custom-loader-wrapper {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(255, 255, 255, 0.95);
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        backdrop-filter: blur(3px);
    }

    /* Fixed Gradient Animated Text Loader - Cross-browser compatible */
    .gradient-text {
        font-size: 4rem;
        font-weight: 900;
        background: linear-gradient(90deg, 
            #973BED 0%, 
            #007CFF 25%, 
            #FFC800 50%, 
            #F0F 75%, 
            #973BED 100%
        );
        background-size: 400% 100%;
        background-position: 0% 0%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
        animation: gradientShift 3s linear infinite;
        letter-spacing: 0.15em;
        user-select: none;
        text-align: center;
        line-height: 1.2;
    }

    /* Firefox specific fix */
    @-moz-document url-prefix() {
        .gradient-text {
            color: transparent !important;
        }
    }

    /* Individual letter bounce animation */
    .gradient-text .letter {
        display: inline-block;
        animation: bounce 1.2s ease-in-out infinite;
        transform-origin: center bottom;
    }
    .gradient-text .letter:nth-child(1) { animation-delay: 0s; }
    .gradient-text .letter:nth-child(2) { animation-delay: 0.1s; }
    .gradient-text .letter:nth-child(3) { animation-delay: 0.2s; }
    .gradient-text .letter:nth-child(4) { animation-delay: 0.3s; }

    @keyframes gradientShift {
        0% {
            background-position: 0% 0%;
        }
        100% {
            background-position: 400% 0%;
        }
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { 
            transform: translateY(0) scale(1); 
        }
        40% { 
            transform: translateY(-15px) scale(1.05); 
        }
        60% { 
            transform: translateY(-8px) scale(1.02); 
        }
    }

    /* Loading dots animation */
    .loading-dots {
        margin-top: 20px;
        text-align: center;
    }

    .loading-dots span {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6366f1;
        margin: 0 4px;
        animation: loadingDots 1.4s ease-in-out infinite both;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }

    @keyframes loadingDots {
        0%, 80%, 100% {
            transform: scale(0);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Fallback for very old browsers that don't support background-clip */
    @supports not (-webkit-background-clip: text) and not (background-clip: text) {
        .gradient-text {
            color: #6366f1 !important;
            background: none !important;
            text-shadow: 2px 2px 4px rgba(99, 102, 241, 0.3);
        }
    }

</style>
{% endblock %}

{% block content %}
<!-- Enhanced Loader -->
<div id="custom-loader-wrapper" class="flex-center">
    <div class="gradient-text" aria-label="Loading">
        <span class="letter">W</span>
        <span class="letter">A</span>
        <span class="letter">I</span>
        <span class="letter">T</span>
    </div>
    <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>

<!-- Quiz Form -->
<div class="quiz-container card" id="quiz-content">
    <h2>Onboarding Quiz</h2>
    <form method="post" action="{% url 'onboarding_quiz' %}" id="quiz-form">
        {% csrf_token %}

        <div class="form-group">
            <label for="id_learning_style">Primary learning style:</label>
            {{ form.learning_style }}
        </div>

        <div class="form-group">
            <label for="id_preferred_subjects">Preferred subjects:</label>
            {{ form.preferred_subjects }}
        </div>

        <div class="form-group">
            <label for="id_skill_level">Skill level:</label>
            {{ form.skill_level }}
        </div>

        <div class="form-group">
            <label for="id_specific_goals">Learning goals:</label>
            {{ form.specific_goals }}
        </div>

        <button type="submit" class="btn" id="submit-btn">Submit</button>
    </form>
    
    {% if form_errors %}
    <div class="error-messages" style="margin-top: 20px; padding: 15px; background-color: #fee; border: 1px solid #fcc; border-radius: 5px; color: #c33;">
        <h4>Please fix the following errors:</h4>
        <ul>
        {% for field, errors in form_errors.items %}
            {% for error in errors %}
                <li><strong>{{ field }}:</strong> {{ error }}</li>
            {% endfor %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if error %}
    <div class="error-messages" style="margin-top: 20px; padding: 15px; background-color: #fee; border: 1px solid #fcc; border-radius: 5px; color: #c33;">
        <h4>Error:</h4>
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    {% if success_message %}
    <div class="success-message" style="margin-top: 20px; padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
        <h4>Success!</h4>
        <p>{{ success_message }}</p>
    </div>
    {% endif %}
</div>

{% if redirect_script %}
    {{ redirect_script|safe }}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('quiz-form');
    const loader = document.getElementById('custom-loader-wrapper');
    const content = document.getElementById('quiz-content');
    const submitBtn = document.getElementById('submit-btn');

    function showLoader() {
        if (loader && content) {
            // Use setTimeout to ensure proper display
            setTimeout(() => {
                loader.style.display = 'flex';
                content.style.display = 'none';
                // Force reflow
                loader.offsetHeight;
            }, 10);
        }
    }

    function hideLoader() {
        if (loader && content) {
            loader.style.display = 'none';
            content.style.display = 'block';
        }
    }

    form.addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent default form submission
        
        // Prevent multiple submissions
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Show loader
        showLoader();
        
        // Submit form via fetch to handle JSON response
        const formData = new FormData(form);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            // Check if response is ok and content-type is JSON
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                // If not JSON, get text to see what the server returned
                return response.text().then(text => {
                    console.error('Server returned non-JSON response:', text);
                    throw new Error('Server returned an error page instead of JSON');
                });
            }
        })
        .then(data => {
            if (data.success && data.redirect_url) {
                // Success - redirect to syllabus
                window.location.href = data.redirect_url;
            } else {
                // Error - show error message
                alert(data.error || data.message || 'An error occurred');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
                hideLoader();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
            hideLoader();
        });
    });

    // Hide loader on page load (in case of back navigation)
    window.addEventListener('load', function() {
        hideLoader();
    });

    // Hide loader if page becomes visible again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            hideLoader();
        }
    });
});
</script>
{% endblock %}
